# 清洁浏览器页面助手 PRD

> 目标平台：Edge & Chrome（MV3 扩展）
> 触发方式：仅手动触发
> 精确指标：内存 + CPU（通过 Native Messaging）

## 1. 背景与目标
用户在浏览器中打开大量标签页，产生重复/相似页面，占用内存并降低效率。本产品通过手动触发扫描，精确识别重复/相似页面并可视化展示高占用标签页，帮助用户安全清理。

## 2. 目标用户
- 重度多标签用户
- 经常进行资料搜集、长时间保持大量打开页面的用户
- 设备内存较小或性能敏感用户

## 3. 成功指标（初期）
- 重复/相似识别准确率 ≥ 85%
- 触发清理后平均减少标签页数量
- 用户接受率（被推荐后实际关闭/合并的比例）
- 7日与30日留存

## 4. 平台与交付形态
- 目标平台：Chrome、Edge
- 交付形态：浏览器扩展（Manifest V3）
- 精确资源指标：扩展 + 本地伴随程序（Native Messaging）
- 数据处理：本地，不上云

## 5. 核心功能（MVP）
1. 重复/相似页面识别
2. 清理建议与手动执行
3. 精确高占用标签页排行（内存 + CPU）
4. 清理统计与可回溯记录

## 6. 用户流程（手动触发）
1. 用户点击扩展按钮或快捷键
2. 扫描当前标签页
3. 输出：
   - 重复/相似页面分组
   - 高占用页面排行（内存、CPU）
4. 用户手动勾选并关闭
5. 展示节省统计（关闭数量、释放内存估算）

## 7. 重复与相似判定（初期规则）
- 完全重复：
  - URL 完全一致
  - 或 标题完全一致
- 相似页面：
  - URL 结构相似度
  - 标题 Token 相似度
  - 内容摘要指纹相似度
- 误报控制：
  - 默认不开启自动清理
  - 每个分组显示代表页 + 预览信息供确认

## 8. 精确资源占用（内存 + CPU）
- 必须从系统级或浏览器进程级数据获取
- 扩展无法直接读取的指标通过本地伴随程序采集
- 排行结果需稳定且可解释
- 若多标签共享进程：标记为“共享进程”并以组形式展示

## 9. 权限与合规
- 扩展权限：
  - tabs
  - tabGroups
  - storage
  - scripting
  - activeTab
  - nativeMessaging
  - debugger
- 本地伴随程序：仅用于读取浏览器进程资源指标
- 用户告知：清晰展示收集范围与用途

## 10. 风险与约束
- Native Messaging 需要安装本地组件，影响用户安装门槛
- 不同平台对进程信息访问策略不同，需要适配
- 相似判断误报风险需通过交互降低

---

# 一、详细技术方案（含消息格式、采样策略、错误处理）

## 1. 架构
- 扩展（MV3）
  - Service Worker：扫描调度、数据聚合、与本地伴随程序通信
  - UI：Popup 或 Side Panel
  - Content Script：页面摘要指纹提取
- 本地伴随程序（Native Messaging）
  - 采样浏览器进程资源
  - 输出与 tab/process 关联数据

## 2. 关键数据流
1. 用户手动触发扫描
2. 扩展收集 tab 基础信息
3. 扩展注入脚本提取摘要指纹
4. 扩展请求本地伴随程序获取 CPU/内存
5. 关联资源数据与 tab
6. 生成重复/相似分组 + 高占用列表
7. 用户勾选并关闭
8. 展示节省统计

## 3. 进程映射策略（核心）
- 目标：将 tab 与 processId 进行稳定映射
- 手段：
  - 通过 chrome.debugger / CDP 获取 target 信息
  - 读取 target 对应 processId（PoC 验证）
- 若无法精确映射：
  - 标记为“共享进程”
  - 仅输出进程级资源占用，并展示该进程包含的所有标签页

## 4. 资源采样策略
- 采样频率：1-2 秒内完成一次采样
- 采样窗口：单次扫描周期内取最近一次采样
- 指标：
  - CPU：百分比
  - 内存：MB 或 Working Set
- 稳定性：
  - 同一时刻多次刷新排序稳定性 ≥ 95%
  - 与系统任务管理器一致性 ≥ 90%

## 5. 内容摘要指纹（Content Script）
- 摘要内容：
  - <title>
  - h1-h3
  - meta description
  - 正文前 N 字符（去噪）
- 处理：
  - 分词/去停用词
  - SimHash 64-bit
- 阈值：
  - 汉明距离 3-5 作为相似判定

## 6. 消息格式（扩展 <-> 本地伴随程序）

### 6.1 扩展 -> 本地伴随程序
```json
{
  "type": "resourceSampleRequest",
  "timestamp": 1738800000,
  "browser": "chrome|edge",
  "tabs": [
    {
      "tabId": 123,
      "windowId": 1,
      "url": "https://example.com",
      "title": "Example",
      "targetId": "CDP_TARGET_ID"
    }
  ]
}
```

### 6.2 本地伴随程序 -> 扩展
```json
{
  "type": "resourceSampleResponse",
  "timestamp": 1738800001,
  "samples": [
    {
      "tabId": 123,
      "processId": 4321,
      "cpuPercent": 8.2,
      "memoryMB": 210.5,
      "sharedProcess": false
    }
  ],
  "unmapped": [
    {
      "tabId": 456,
      "reason": "no_process_match"
    }
  ]
}
```

## 7. 错误处理
- 无法连接本地伴随程序：
  - UI 提示安装或权限说明
  - 高占用排行显示为不可用
- 资源采样失败：
  - 输出错误码与重试提示
- tab 进程映射失败：
  - 标记“共享进程/未知进程”
  - 仅展示进程级信息

---

# 二、交互流程图（文本版原型）

## 1. 主入口
- 扩展图标点击 / 快捷键
- UI 顶部状态：扫描中 / 扫描完成
- 按钮：重新扫描

## 2. Tab 切换
- 重复/相似
- 高占用

## 3. 重复/相似页面视图
- 分组列表（显示重复原因/相似度）
- 每组展示代表页标题 + URL
- 展开显示所有 tab
- 操作：保留此页 / 关闭其余

## 4. 高占用页面视图
- 按 CPU 或 内存排序
- 每项显示：
  - 标题 + URL
  - CPU%、内存MB
  - 标签缩略图
  - 若共享进程：标记“共享”
- 操作：关闭 / 保留

## 5. 底部统计
- 本次关闭数量
- 预计释放内存

---

# 三、MVP 验收用例清单

## 1. 功能类
1. 手动触发扫描，UI 显示“扫描中/完成”
2. 重复页面可被识别并分组
3. 相似页面可被识别并分组
4. 手动勾选关闭后，标签页被正确关闭
5. 清理统计显示关闭数量与释放内存估算

## 2. 资源精确性
6. CPU + 内存排行与浏览器任务管理器一致性 ≥ 90%
7. 排行在 3 次刷新内稳定性 ≥ 95%
8. 共享进程标签页被正确标记

## 3. 可靠性与错误处理
9. 本地伴随程序不可用时 UI 明确提示
10. 采样失败时显示错误状态并允许重试
11. 进程映射失败时显示“共享/未知进程”

## 4. 性能
12. 100+ 标签扫描耗时 ≤ 3 秒
13. 扫描期间浏览器无明显卡顿

---

# 附：PoC 可行性验证计划

1. 构建最小扩展：列出 tabs 与基础信息
2. 构建本地伴随程序：读取 Chrome/Edge 进程 CPU/内存
3. 验证 tab 与 processId 关联可行性
4. 与浏览器任务管理器比对
5. 输出结论：
   - 是否可做到每 tab 精确
   - 或需标记共享进程

